---
- name: Minimal cross-distro setup
  hosts: all
  become: yes
  gather_facts: true
  vars_files:
    - vars.yml

  tasks:
    # Update repo cache and upgrade packages for Ubuntu and RedHat
    - name: Update repo cache (Ubuntu)
      apt:
        update_cache: yes
      when: ansible_facts['os_family'] == "Debian"

    - name: Upgrade all packages (Ubuntu)
      apt:
        upgrade: dist
      when: ansible_facts['os_family'] == "Debian"

    - name: Update repo cache (RedHat)
      dnf:
        update_cache: yes
      when: ansible_facts['os_family'] == "RedHat"

    - name: Upgrade all packages (RedHat)
      dnf:
        name: "*"
        state: latest
      when: ansible_facts['os_family'] == "RedHat"

    # Ensure Apache is installed and running on Ubuntu
    - name: Ensure Apache is installed (Ubuntu)
      apt:
        name: apache2
        state: present
      when: ansible_facts['os_family'] == "Debian"

    # due to testing curl http://localhost:8080
    - name: Set ServerName to localhost in Apache config (Ubuntu)
      command:
        cmd: echo "ServerName localhost" >> /etc/apache2/apache2.conf
      when: ansible_facts['os_family'] == "Debian"

    - name: Start Apache (Ubuntu)
      command:
        cmd: apachectl -k start
      when: ansible_facts['os_family'] == "Debian"

    # Wait for Apache to be ready on port 80
    - name: Wait for Apache to be ready (Ubuntu)
      wait_for:
        port: 80
        delay: 10
        timeout: 60
        state: started
      when: ansible_facts['os_family'] == "Debian"

    # Deploy Hello World page (Ubuntu)
    - name: Deploy Hello World page (Ubuntu)
      copy:
        dest: /var/www/html/index.html
        content: "{{ hello_page }}"
      notify: Reload Apache on Ubuntu
      when: ansible_facts['os_family'] == "Debian"

    # Ensure MariaDB is installed on RedHat
    - name: Ensure MariaDB is installed (RedHat)
      dnf:
        name: mariadb-server
        state: present
      when: ansible_facts['os_family'] == "RedHat"

  handlers:
    - name: Reload Apache on Ubuntu
      block:
        - name: Reload via systemd if available
          service:
            name: apache2
            state: reloaded
          when: ansible_facts['service_mgr'] == "systemd"

        - name: Fallback reload via apachectl
          command: "{{ item }}"
          changed_when: true
          failed_when: false
          loop:
            - apachectl -k graceful
            - /usr/sbin/apache2ctl -k graceful
          when: ansible_facts['service_mgr'] != "systemd"